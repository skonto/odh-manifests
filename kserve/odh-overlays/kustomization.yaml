---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - ../kserve-built
  - network-policies.yaml

vars:
  - name: NAMESPACE
    objref:
      apiVersion: v1
      kind: Namespace
      name: kserve

patches:
  - path: ./kserve-controller-manager-patch.yaml
  - path: ./inferenceservice-config-patch.yaml
  - path: ./kserve-webhook-certificate-patch.yaml

  # Remove invalid CA bundles
  - patch: |-
      - op: remove
        path: "/spec/conversion/webhook/clientConfig/caBundle"
    target:
      kind: CustomResourceDefinition
      name: inferenceservices.serving.kserve.io
  - patch: |-
      - op: remove
        path: "/webhooks/0/clientConfig/caBundle"
      - op: remove
        path: "/webhooks/1/clientConfig/caBundle"
    target:
      kind: MutatingWebhookConfiguration
  - patch: |-
      - op: remove
        path: "/webhooks/0/clientConfig/caBundle"
    target:
      kind: ValidatingWebhookConfiguration

  # Inject CA bundle into webhooks
  - patch: |-
      - op: add
        path: "/metadata/annotations/cert-manager.io~1inject-ca-from"
        value: "$(NAMESPACE)/serving-cert"
    target:
      kind: MutatingWebhookConfiguration
  - patch: |-
      - op: add
        path: "/metadata/annotations/cert-manager.io~1inject-ca-from"
        value: "$(NAMESPACE)/serving-cert"
    target:
      kind: ValidatingWebhookConfiguration

configurations:
  - params.yaml
